<!doctype html><html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns#"><title>Buck: Macros</title><link type="image/png" rel="icon" href="/buck/favicon.png" /><meta http-equiv="content-type" content="text/html;charset=utf-8"><link type="text/css" rel="stylesheet" href="/buck/google-code-prettify/prettify.css" ><link type="text/css" rel="stylesheet" href="/buck/buck.css"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-40185670-1', 'github.io'); ga('send', 'pageview');</script><meta property="og:locale" content="en_US"><meta property="og:title" content="Macros"><meta property="og:site_name" content="Buck: an Android build tool"><meta property="og:image" content="http://newsroom.fb.com/display-media/265/4"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="690"><meta property="og:image:height" content="690"><meta property="og:type" content="article"><meta property="fb:admins" content="584556688222168"></head><body><a href="https://github.com/facebook/buck"><img id="fork" src="/buck/fork_me.png" alt="Fork me on GitHub"></a><div id="fb-root"></div><script>(function(d, s, id) {var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=584556688222168"; fjs.parentNode.insertBefore(js, fjs);}(document, 'script', 'facebook-jssdk'));</script><h1><div class="titlebar"><div class="fb-like buck_like" data-send="false" data-layout="standard" data-width="350" data-show-faces="false" data-colorscheme="light" data-action="like"></div><div>Buck: Macros</div></div></h1><div class="content_frame"><div class="toc"><ul class="toc_root"><li><span class="toc_header">Getting Started</span><ul><li><a href="/buck/">Overview</a><li><a href="/buck/setup/quickstart.html">Quick Start</a><li><a href="/buck/setup/install.html">Downloading and Installing Buck</a></ul><li><span class="toc_header">Concepts</span><ul><li><a href="/buck/concept/build_rule.html">Build Rule</a><li><a href="/buck/concept/build_target.html">Build Target</a><li><a href="/buck/concept/build_file.html">Build File</a><li><a href="/buck/concept/buckversion.html">.buckversion</a><li><a href="/buck/concept/nobuckcheck.html">.nobuckcheck</a><li><a href="/buck/concept/buckconfig.html">.buckconfig</a><li><a href="/buck/concept/build_target_pattern.html">Build Target Pattern</a><li><a href="/buck/concept/visibility.html">Visibility</a><li><a href="/buck/concept/troubleshooting.html">Troubleshooting</a><li><a href="/buck/concept/faq.html">FAQ</a></ul><li><span class="toc_header">Build Rules</span><ul><li><a href="/buck/rule/android_binary.html">android_binary()</a><li><a href="/buck/rule/android_library.html">android_library()</a><li><a href="/buck/rule/android_resource.html">android_resource()</a><li><a href="/buck/rule/apk_genrule.html">apk_genrule()</a><li><a href="/buck/rule/gen_aidl.html">gen_aidl()</a><li><a href="/buck/rule/genrule.html">genrule()</a><li><a href="/buck/rule/java_binary.html">java_binary()</a><li><a href="/buck/rule/java_library.html">java_library()</a><li><a href="/buck/rule/java_test.html">java_test()</a><li><a href="/buck/rule/keystore.html">keystore()</a><li><a href="/buck/rule/ndk_library.html">ndk_library()</a><li><a href="/buck/rule/prebuilt_jar.html">prebuilt_jar()</a><li><a href="/buck/rule/prebuilt_native_library.html">prebuilt_native_library()</a><li><a href="/buck/rule/project_config.html">project_config()</a></ul><li><span class="toc_header">Functions</span><ul><li><a href="/buck/function/genfile.html">genfile()</a><li><a href="/buck/function/glob.html">glob()</a><li><a href="/buck/function/include_defs.html">include_defs()</a></ul><li><span class="toc_header">Commands</span><ul><li><a href="/buck/command/audit.html">buck audit</a><li><a href="/buck/command/build.html">buck build</a><li><a href="/buck/command/clean.html">buck clean</a><li><a href="/buck/command/install.html">buck install</a><li><a href="/buck/command/project.html">buck project</a><li><a href="/buck/command/targets.html">buck targets</a><li><a href="/buck/command/test.html">buck test</a><li><a href="/buck/command/uninstall.html">buck uninstall</a><li><a href="/buck/command/buckd.html">buckd</a></ul><li><span class="toc_header">Extending Buck</span><ul><li><a href="/buck/extending/macros.html">Custom Macros</a><li><a href="/buck/extending/rules.html">Custom Rules</a></ul><li><span class="toc_header">Contributing to Buck</span><ul><li><a href="https://groups.google.com/group/buck-build">Discussion Group</a><li><a href="https://github.com/facebook/buck/issues/new">Report a Bug</a><li><a href="/buck/contributing/development.html">Development Workflow</a><li><a href="/buck/contributing/codestyle.html">Code Style</a><li><a href="/buck/javadoc">API</a><li><a href="https://github.com/facebook/buck">Browse the Source Code</a></ul></ul></div><div class="content"><div class="overview">Because build files accept valid Python code, it is possible to define Python functions that have the side-effect of creating build rules. Such functions are called <strong>macros</strong>.<p><strong>Warning:</strong> Although build files are evaluated as Python and can therefore do anything (write files, access the network, etc.), doing so may cause Buck to fail in peculiar ways and is therefore neither supported nor encouraged.<p>For example, here is a macro named <code>java_library_using_guava</code> to create a build rule that creates a <code>java_library</code> rule that depends on Guava:<pre class="prettyprint lang-py">
def java_library_using_guava(
    name,
    srcs=[],
    resources=[],
    deps=[],
    visibility=[]):
  java_library(
    name = name,
    srcs = srcs,
    resources = resources,
    deps = [
      # This assumes this is where Guava is in your project.
      '//third_party/java/guava:guava',
    ] + deps,
    visibility = visibility,
  )
</pre>Calling this function looks the same as defining a built-in build rule:<pre class="prettyprint lang-py">
# Calling this function has the side-effect of creating
# a java_library() rule named 'util' that depends on Guava.
java_library_using_guava(
  name = 'util',
  # Source code that depends on Guava.
  srcs = glob(['*.java']),
)
</pre>You can also create more sophisticated macros that create multiple build rules. For example, you might want to create a single build rule that produces both debug and release versions of an APK:<pre class="prettyprint lang-py">
def create_apks(
    name,
    manifest,
    debug_keystore,
    release_keystore,
    proguard_config,
    deps):

  # This loop will create two android_binary rules.
  for type in [ 'debug', 'release' ]:
    # Select the appropriate keystore.
    if type == 'debug':
      keystore = debug_keystore
    else:
      keystore = release_keystore

    android_binary(
      # Note how we must parameterize the name of the
      # build rule so that we avoid creating two build
      # rules with the same name.
      name = '%s_%s' % (name, type),
      manifest = manifest,
      target = 'Google Inc.:Google APIs:16',
      keystore = keystore,
      package_type = type,
      proguard_config = proguard_config,
      deps = deps,
      visibility = [
        'PUBLIC',
      ],
    )
)
</pre>Again, using this looks the same as defining a built-in build rule:<pre class="prettyprint lang-py">
create_apks(
  name = 'messenger',
  manifest = 'AndroidManifest.xml',
  debug_keystore = '//keystores:debug',
  release_keystore = '//keystores:prod',
  proguard_config = 'proguard.cfg',
  deps = [
    # ...
  ],
)
</pre>Note that if this were defined in <code>apps/messenger/BUCK</code>, then this would create the following build rules:<pre>
//apps/messenger:messenger_debug
//apps/messenger:messenger_release
</pre>However, the following build rule would <strong>NOT</strong> exist:<pre>//apps/messenger:messenger</pre>This may be confusing to developers who expect the following commands to work:<pre>
buck build //apps/messenger:messenger
buck targets --type create_apks
</pre>Including your company name as a prefix to the name of your macro may help enforce the idea that your macro is not a built-in rule. On the other hand, part of the beauty of macros is that they are as familiar to use as built-in rules. How you communicate this to your team is up to you.</div></div></div><script src="/buck/google-code-prettify/prettify.js"></script><script>prettyPrint()</script></body></html>